# Анализ несоответствий и унифицированная архитектура системы уведомлений

## Текущая реализация

### Архитектура модулей

- **AssetsModule**: AssetUpdateService (cron каждые 4 часа для обновлений активов)
- **NotificationsModule**: SchedulerService (cron каждые 2 часа для алертов, ежедневно для отчетов), AlertService, ReportService, EmailService

### Поток работы

1. AssetUpdateService обновляет все активы каждые 4 часа
2. SchedulerService проверяет алерты каждые 2 часа (независимо от обновлений)
3. SchedulerService генерирует отчеты ежедневно

## Ключевые несоответствия требованиям

### 1. Множественные schedulers вместо одного

**Текущее состояние:**

- AssetUpdateService имеет собственный cron для обновлений
- SchedulerService имеет отдельные cron для алертов и отчетов

**Требования:** Один scheduler для триггера обновлений активов по пользовательским настройкам

**Проблема:** Разделение логики планирования, отсутствие связи между обновлениями и алертами

### 2. Раздельные сервисы уведомлений вместо одного

**Текущее состояние:**

- AlertService для алертов
- ReportService для отчетов
- EmailService для отправки email

**Требования:** Один сервис за уведомления

**Проблема:** Разделение ответственности, дублирование логики отправки уведомлений

### 3. Логика алертов не соответствует требованиям

**Текущее состояние:**

- AlertService сравнивает текущую цену с middlePrice
- Проверки каждые 2 часа независимо от обновлений

**Требования:** Вычисления и алерты по изменениям (после обновлений)

**Проблема:** Алеры не связаны с фактическими обновлениями цен, сравнение с middlePrice вместо изменений

### 4. Отчеты не соответствуют "без обновления данных"

**Текущее состояние:**

- Отчеты генерируются ежедневно, но логика включает изменения за день

**Требования:** Отчеты по периодам без обновления данных

**Проблема:** Отчеты зависят от обновленных данных, но генерируются отдельно

## Предлагаемая унифицированная архитектура

### Основные изменения

1. **Единый SchedulerService** - отвечает за все cron задачи:
   - Обновления активов по пользовательским интервалам (по умолчанию 4 часа)
   - Проверку алертов сразу после обновлений
   - Генерацию отчетов по периодам (ежедневно/еженедельно/ежемесячно)

2. **Единый NotificationService** - объединяет все типы уведомлений:
   - Алеры по изменениям цен
   - Отчеты по портфелю
   - Отправка email через встроенный EmailService

3. **Интеграция обновлений и алертов**:
   - После обновления активов сразу проверять алерты на основе изменений
   - Пользовательские настройки интервалов обновлений

### Диаграмма унифицированной архитектуры

```mermaid
graph TD
    A[SchedulerService] --> B[AssetUpdateService.updateAssets()]
    B --> C[NotificationService.checkAlerts()]
    A --> D[NotificationService.generateReports()]
    C --> E[EmailService.sendEmail()]
    D --> E

    F[NotificationSettings] --> A
    G[Asset] --> B
    G --> C
    G --> D

    A --> H[@nestjs/schedule]
```

### Изменения в сервисах

#### SchedulerService

- Удалить cron из AssetUpdateService
- Добавить cron для обновлений активов по пользовательским настройкам
- Интегрировать вызов алертов после обновлений
- Добавить cron для отчетов по периодам

#### NotificationService (новый)

- Объединить AlertService, ReportService, EmailService
- Методы:
  - `checkAlertsAfterUpdate(userId?, assetIds?)` - проверка алертов после обновлений
  - `generatePeriodicReports(period)` - генерация отчетов без обновления данных
  - `sendNotification(type, user, data)` - унифицированная отправка уведомлений

#### AssetUpdateService

- Удалить @Cron декоратор
- Добавить методы для обновлений по пользовательским настройкам
- Интегрировать с SchedulerService

### План реализации

1. **Создать NotificationService**
   - Объединить логику из AlertService, ReportService, EmailService
   - Добавить унифицированные методы отправки уведомлений

2. **Модифицировать SchedulerService**
   - Добавить cron для обновлений активов
   - Интегрировать последовательность: обновление -> алерты
   - Настроить cron для отчетов

3. **Обновить AssetUpdateService**
   - Удалить @Cron
   - Добавить поддержку пользовательских интервалов
   - Вернуть результаты обновлений для алертов

4. **Обновить NotificationSettings**
   - Добавить поле для интервала обновлений (по умолчанию 4 часа)

5. **Тестирование интеграции**
   - Убедиться, что алерты вызываются только после обновлений
   - Проверить пользовательские интервалы
   - Валидировать отчеты без обновления данных

### Преимущества унифицированной архитектуры

- **Централизованное планирование:** Один scheduler управляет всеми задачами
- **Связанные обновления и алерты:** Алеры только после фактических изменений
- **Упрощенная структура:** Один сервис для всех уведомлений
- **Гибкость:** Поддержка пользовательских интервалов обновлений
- **Производительность:** Избегание лишних проверок алертов
